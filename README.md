# OpenAI Summarize Diff Action

This GitHub Action receives a git diff (e.g., a PR diff) and uses OpenAI to summarize and explain the changes made in that diff in a clear, concise way.

## Features

- Generates concise explanations of code changes
- Customizable output length and style
- Easy to integrate into your CI/CD workflow
- Now includes comprehensive tests and error handling

## Inputs

### `diff`

**Required** The diff to be explained.

### `apikey`

**Required** Your OpenAI API key. Get one at [OpenAI Platform](https://platform.openai.com/api-keys).

### `examplePostSummary`

**Optional** An example summary to guide the model's output style.
Default: "update the code with new features: parallelisation, caching, and better error handling"

### `maxTokens`

**Optional** Maximum number of tokens to generate. Default: `30`

### `maxCharacters`

**Optional** Maximum characters in the generated explanation. Default: `140`

## Outputs

### `explanation`

The explanation and summary of the diff generated by OpenAI.

## Example usage

### To explain the changes made in a PR

```yaml
name: Explain PR Changes

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  explain-diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}..HEAD)
          echo "DIFF<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Explain Diff
        id: explain
        uses: grey/openai-summarize-diff-action@main
        with:
          diff: ${{ env.DIFF }}
          apikey: ${{ secrets.OPENAI_API_KEY }}
          
      - name: Output explanation
        run: echo "${{ steps.explain.outputs.explanation }}"
```

### To explain the changes and post the result as a comment in the PR

```yaml
name: Explain PR Changes and Comment

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  explain-diff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}..HEAD)
          echo "DIFF<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Explain Diff
        id: explain
        uses: grey/openai-summarize-diff-action@main
        with:
          diff: ${{ env.DIFF }}
          apikey: ${{ secrets.OPENAI_API_KEY }}
          
      - name: Post comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const explanation = process.env.EXPLANATION;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– AI Summary of Changes\n\n${explanation}`
            });
        env:
          EXPLANATION: ${{ steps.explain.outputs.explanation }}
```

## Local Development

### Setup

1. Clone the repository:
   ```bash
   git clone https://github.com/your-username/openai-summarize-diff-action.git
   cd openai-summarize-diff-action
   ```

2. Install dependencies:
   ```bash
   npm install
   ```

3. Create a `.env` file with your OpenAI API key:
   ```
   OPENAI_API_KEY=your_api_key_here
   ```

### Testing

Run tests:
```bash
npm test
```

Run tests with coverage:
```bash
npm run test:coverage
```

Run tests in watch mode (useful during development):
```bash
npm run test:watch
```

### Linting

Run linting:
```bash
npm run lint
```

### Building

Build the action:
```bash
npm run build
```

This will run linting, tests, and then build the action into the `dist` directory.

### Manual Testing

You can test the action locally by creating a test script:

```javascript
// test-local.js
require('dotenv').config();
const { generateDiffExplanation } = require('./src/openai');

async function test() {
  const diff = `diff --git a/file.js b/file.js
index 123..456 789
--- a/file.js
+++ b/file.js
@@ -1,3 +1,4 @@
 const a = 1;
+const b = 2;
 const c = 3;`;

  try {
    const explanation = await generateDiffExplanation({
      diff,
      apiKey: process.env.OPENAI_API_KEY,
      maxTokens: 50,
      maxCharacters: 200
    });
    
    console.log('Explanation:', explanation);
  } catch (error) {
    console.error('Error:', error.message);
  }
}

test();
```

Run the test script:
```bash
node test-local.js
```

## Notes

- This action uses OpenAI's GPT-4o-mini model by default.
- Make sure to store your OpenAI API key as a secret in your repository settings.
- The action will ignore library folders to focus on meaningful code changes.

## License

ISC